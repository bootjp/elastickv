name: Jepsen VM Run

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      time-limit:
        description: "Workload runtime seconds"
        required: false
        default: "60"
      rate:
        description: "Ops/sec per worker"
        required: false
        default: "10"
      faults:
        description: "Comma-separated faults (partition,kill,clock)"
        required: false
        default: "partition,kill,clock"

jobs:
  jepsen:
    # Requires a runner with KVM support (e.g. larger GitHub runners or metal) for decent performance.
    # Standard ubuntu-latest might fall back to QEMU TCG (very slow) or fail if kvm driver is forced.
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"

      - name: Install Vagrant and Libvirt
        run: |
          sudo apt-get update
          sudo apt-get install -y vagrant ruby-libvirt qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils libvirt-dev gcc make
          
          # Check KVM support
          echo "Checking KVM support..."
          if [ -r /dev/kvm ]; then
            echo "KVM is available."
          else
            echo "WARNING: KVM is NOT available. VMs may run very slowly or fail."
          fi

          # Setup Libvirt permissions
          sudo usermod -aG libvirt $USER
          # Allow current session to access libvirt socket
          sudo chmod 666 /var/run/libvirt/libvirt-sock
          
          # Install Vagrant plugins
          vagrant plugin install vagrant-libvirt
          vagrant plugin install vagrant-scp

      - name: Bring up Jepsen VMs
        working-directory: jepsen
        run: vagrant up --provider=libvirt

      - name: Run Jepsen workload
        working-directory: jepsen
        env:
          HOME: ${{ github.workspace }}/jepsen/tmp-home
          LEIN_HOME: ${{ github.workspace }}/jepsen/.lein
          LEIN_JVM_OPTS: -Duser.home=${{ github.workspace }}/jepsen/tmp-home
        run: |
          vagrant ssh ctrl -c "cd ~/elastickv/jepsen && \
            lein run -m elastickv.redis-workload \
              --nodes n1,n2,n3,n4,n5 \
              --time-limit ${{ github.event.inputs['time-limit'] || github.event.inputs.time-limit }} \
              --rate ${{ github.event.inputs['rate'] || github.event.inputs.rate }} \
              --faults ${{ github.event.inputs['faults'] || github.event.inputs.faults }} \
              --concurrency 10"

      - name: Collect Jepsen artifacts
        if: always()
        working-directory: jepsen
        run: |
          mkdir -p $GITHUB_WORKSPACE/artifacts
          vagrant ssh ctrl -c "cd ~/elastickv/jepsen && tar czf /home/vagrant/results.tgz store/ target/ tmp-home/jepsen.store || true"
          vagrant scp ctrl:/home/vagrant/results.tgz $GITHUB_WORKSPACE/artifacts/results.tgz || true

      - name: Destroy VMs
        if: always()
        working-directory: jepsen
        run: vagrant destroy -f

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jepsen-results
          path: artifacts/results.tgz